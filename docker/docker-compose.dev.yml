# =============================================================================
# Docker Compose - Development Environment
# =============================================================================
# This configuration runs PostgreSQL + Backend Express server for development
# Frontend (Next.js) is NOT included as it runs on Vercel
#
# Usage:
#   Start: docker-compose -f docker/docker-compose.dev.yml up -d
#   Stop:  docker-compose -f docker/docker-compose.dev.yml down
#   Logs:  docker-compose -f docker/docker-compose.dev.yml logs -f
# =============================================================================

version: '3.8'

services:
  # ---------------------------------------------------------------------------
  # PostgreSQL Database
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:16-alpine
    container_name: saas_postgres_dev
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
      POSTGRES_DB: ${POSTGRES_DB:-saas}
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data
      # Optional: Mount init scripts
      # - ../migrations:/docker-entrypoint-initdb.d:ro
    ports:
      - '${POSTGRES_PORT:-5432}:5432'
    networks:
      - saas-network
    healthcheck:
      test: [CMD-SHELL, 'pg_isready -U ${POSTGRES_USER:-user} -d ${POSTGRES_DB:-saas}']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Express Backend Server (Development Mode with Hot Reload)
  # ---------------------------------------------------------------------------
  backend:
    container_name: saas_backend_dev
    build:
      context: ..
      dockerfile: docker/Dockerfile.backend
      target: deps # Use deps stage for development
    command: npm run dev # Hot reload with nodemon
    working_dir: /app
    volumes:
      # Mount source code for hot reload
      - ../server/src:/app/src:cached
      - ../server/package.json:/app/package.json
      - ../server/package-lock.json:/app/package-lock.json
      - ../server/tsconfig.json:/app/tsconfig.json
      # Prevent node_modules from being overwritten
      - backend_node_modules:/app/node_modules
    ports:
      - '${BACKEND_PORT:-3001}:3001'
    environment:
      NODE_ENV: development
      PORT: 3001
      DATABASE_URL: postgresql://${POSTGRES_USER:-user}:${POSTGRES_PASSWORD:-password}@postgres:5432/${POSTGRES_DB:-saas}
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000,https://*.vercel.app}
      # Add other environment variables from .env
    env_file:
      - ../server/.env
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - saas-network
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Drizzle Studio (Optional - Database Management UI)
  # ---------------------------------------------------------------------------
  drizzle-studio:
    container_name: saas_drizzle_studio_dev
    image: node:20-alpine
    working_dir: /app
    command: sh -c "npx drizzle-kit studio --port 5555 --host 0.0.0.0"
    volumes:
      - ../:/app:cached
      - studio_node_modules:/app/node_modules
    ports:
      - '${DRIZZLE_STUDIO_PORT:-5555}:5555'
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-user}:${POSTGRES_PASSWORD:-password}@postgres:5432/${POSTGRES_DB:-saas}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - saas-network
    restart: unless-stopped
    profiles:
      - studio # Only start when explicitly requested

# =============================================================================
# Networks
# =============================================================================
networks:
  saas-network:
    driver: bridge
    name: saas_dev_network

# =============================================================================
# Volumes
# =============================================================================
volumes:
  postgres_dev_data:
    name: saas_postgres_dev_data
  backend_node_modules:
    name: saas_backend_dev_node_modules
  studio_node_modules:
    name: saas_studio_dev_node_modules
